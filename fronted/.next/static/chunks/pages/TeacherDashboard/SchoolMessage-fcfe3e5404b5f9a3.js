(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6594],{432:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>o});var r=t(7876),a=t(4232),l=t(1777),n=t(960),c=t(6984);let d=()=>{{let e=localStorage.getItem("token");if(!e)return null;try{return(0,c.s)(e).schoolId||null}catch(e){return console.error("Invalid token",e),null}}};function o(){let{teacher:e}=(0,l.d4)(e=>e.teacher),[s,t]=(0,a.useState)(null),[c,o]=(0,a.useState)(!0);return((0,a.useEffect)(()=>{(async()=>{try{let s=null;if(s=e&&e.schoolId?e.schoolId:d(),t(s),!s){console.error("No schoolId found"),o(!1);return}}catch(e){console.error("Failed to fetch school details",e)}finally{o(!1)}})()},[e]),c)?(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-100",children:(0,r.jsx)("div",{className:"text-center animate-pulse",children:(0,r.jsx)("p",{className:"text-lg text-gray-600",children:"Loading your school chat..."})})}):e&&s?(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 p-6",children:(0,r.jsxs)("div",{className:"max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6",children:[(0,r.jsxs)("h1",{className:"text-3xl font-extrabold text-blue-700 mb-4",children:["Welcome, ",e.name||"Teacher","!"]}),(0,r.jsxs)("p",{className:"text-lg text-gray-700 mb-6",children:["You are connected to: ",(0,r.jsx)("span",{className:"font-semibold",children:s.schoolName})]}),(0,r.jsx)("div",{className:"border-t pt-4",children:(0,r.jsx)(n.A,{receiverId:s,receiverType:"School",currentUserId:e.id,currentUserType:"Teacher"})})]})}):(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-100",children:(0,r.jsx)("div",{className:"text-center",children:(0,r.jsx)("p",{className:"text-lg text-red-600",children:"Failed to load teacher or school details."})})})}},960:(e,s,t)=>{"use strict";t.d(s,{A:()=>d});var r=t(7876),a=t(4232),l=t(1777),n=t(829),c=t(5362);function d(e){let{receiverId:s,receiverType:t,currentUserId:d,currentUserType:o}=e,i=(0,a.useContext)(n.d),m=(0,l.wA)(),{messages:h,conversationId:u,loading:x,error:g}=(0,l.d4)(e=>e.message),[f,p]=(0,a.useState)(""),v=(0,a.useRef)(null);(0,a.useEffect)(()=>{d&&s&&m((0,c.p5)({participant1:d,participant2:s}))},[m,d,s]),(0,a.useEffect)(()=>{if(!i)return;let e=e=>{(e.senderId===s&&e.receiverId===d||e.senderId===d&&e.receiverId===s)&&m((0,c.tj)(e))},t=e=>{let{messageId:s}=e;m((0,c.lg)({messageId:s,status:"delivered"}))},r=e=>{let{messageIds:s}=e;m((0,c.iS)({messageIds:s}))};return i.on("newMessage",e),i.on("messageDelivered",t),i.on("messageRead",r),()=>{i.off("newMessage",e),i.off("messageDelivered",t),i.off("messageRead",r)}},[i,s,d,m]),(0,a.useEffect)(()=>{var e;null==(e=v.current)||e.scrollIntoView({behavior:"smooth"})},[h]),(0,a.useEffect)(()=>{if(!i||!h||0===h.length)return;let e=h.filter(e=>e.senderId===s&&e.receiverId===d&&"seen"!==e.status);console.log("Total unread messages:",e),e.length>0&&(i.emit("readMessages",{senderId:s,receiverId:d}),console.log("Sent readMessages event to socket for",s,"->",d))},[h,i,s,d,m]);let N=()=>{""!==f.trim()&&(i.emit("sendMessage",{senderId:d,receiverId:s,senderType:o,receiverType:t,message:f.trim()}),p(""))},j=Array.isArray(h)?h.filter(e=>e.senderId===s&&e.receiverId===d||e.senderId===d&&e.receiverId===s):[];return(0,r.jsxs)("div",{className:"border p-4 rounded shadow",children:[(0,r.jsxs)("div",{className:"h-64 overflow-y-auto bg-gray-100 p-2 mb-2",children:[0===j.length?(0,r.jsx)("div",{children:"No messages yet"}):j.map(e=>(0,r.jsx)("div",{className:"mb-1 ".concat(e.senderId===d?"text-right":"text-left"),children:(0,r.jsxs)("span",{className:"inline-block bg-white p-1 rounded shadow",children:["string"==typeof e.message?e.message:e.message&&"object"==typeof e.message&&e.message.message?e.message.message:JSON.stringify(e.message),"sent"===e.status&&(0,r.jsx)("span",{className:"text-xs ml-1",children:"✔"}),"delivered"===e.status&&(0,r.jsx)("span",{className:"text-xs ml-1",children:"✔✔"}),"seen"===e.status&&(0,r.jsx)("span",{className:"text-xs text-amber-700 ml-1",children:"✔t✔"})]})},e._id)),(0,r.jsx)("div",{ref:v})]}),(0,r.jsxs)("div",{className:"flex",children:[(0,r.jsx)("input",{className:"flex-1 border p-1 rounded-l",value:f,onChange:e=>p(e.target.value),placeholder:"Type a message...",onKeyDown:e=>{"Enter"===e.key&&N()}}),(0,r.jsx)("button",{className:"bg-blue-500 text-white px-4 rounded-r",onClick:N,children:"Send"})]})]})}},8052:(e,s,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/TeacherDashboard/SchoolMessage",function(){return t(432)}])}},e=>{var s=s=>e(e.s=s);e.O(0,[636,6593,8792],()=>s(8052)),_N_E=e.O()}]);